<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基于vue reactivity的 webcomponent框架</title>
    <!-- <link rel="stylesheet" href="/assets/app.css?v=0.0.3" /> -->
    <script src="/assets/eval5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jss/10.9.2/jss.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jss-preset-default@10.9.0/dist/jss-preset-default.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script>
        if (location.hash === '') {
            history.replaceState({path: '', nid: 'main'},'',location.href + '#/')
        }

        window.jssStyleMan = jss.default.setup(jssPresetDefault.default);
        let vueapp = window.Vue.createApp({});
        vueapp.config.devtools = true;
        let VueDemi = (function () {
            var _VueDemi = {}
            for (var key in Vue) {
                _VueDemi[key] = Vue[key]
            }
            _VueDemi.isVue2 = false
            _VueDemi.isVue3 = true
            _VueDemi.install = function () { }
            _VueDemi.Vue = Vue
            _VueDemi.Vue2 = undefined
            _VueDemi.version = Vue.version
            _VueDemi.set = function (target, key, val) {
                if (Array.isArray(target)) {
                    target.length = Math.max(target.length, key)
                    target.splice(key, 1, val)
                    return val
                }
                target[key] = val
                return val
            }
            _VueDemi.del = function (target, key) {
                if (Array.isArray(target)) {
                    target.splice(key, 1)
                    return
                }
                delete target[key]
            }
            return _VueDemi
        })();
        globalThis.VueDemi = VueDemi;
    </script>
    <script src="https://cdn.bootcdn.net/ajax/libs/pinia/2.0.35/pinia.iife.js"></script>
    <!-- <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        var vConsole = new window.VConsole();
    </script> -->

    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
        }

        #routerroot {
            overflow: auto;
        }

        #nav {
            position: sticky;
            top: 0;
        }
    </style>
    <link rel="stylesheet" href="/assets/uno.css" />
<link rel="stylesheet" href="/assets/webelef/webele_fabc942a.css" />

</head>

<body>
    <div id="routerroot" class="h-full"></div>
    <script type="importmap">
        {
          "imports": {"async-validator":"https://cdn.jsdelivr.net/npm/async-validator@4.2.5/+esm","vue":"https://cdn.jsdelivr.net/npm/vue@3.3.4/+esm","wlepre":"/assets/wle-provider/index.js?v=0.0.3","wle":"/assets/webelef/main_esm_09e5fd75.js?v=1692872704473"}
        }
    </script>
    <script type="module" src="/assets/ele/elastic-textarea.js?v=1.0.7"></script>
    <script type="module">

        async function importCss(url) {
            const cssFile = await fetch(url);
            const css = await cssFile.text();

            let parsedcss = css;
            let winWidth = window.innerWidth;

            if (winWidth > 768) {
                parsedcss = css.replace(/(\d+)(?=rpx)rpx/g, function(pxs, ...pxargs) {
                    return pxs.replace('rpx', 'px')
                });
            }
            else {
                parsedcss = css.replace(/(\d+)(?=rpx)rpx/g, function(pxs, ...pxargs) {
                    let val = pxargs[0]
                    return pxs.replace('rpx', 'px').replace(val, val / 750 * winWidth)
                })
            }

            // console.log(parsedcss);
            const myStyleSheet = new CSSStyleSheet();
            myStyleSheet.replace(parsedcss);
            return myStyleSheet;
        }

        let cssFileName = '/assets/webelef/app_16a495c4.css';
        let myStyleSheet = await importCss(cssFileName);
        document.adoptedStyleSheets.push(myStyleSheet);

        // const cssModule = await import(cssFileName, {
        //     assert: { type: 'css' }
        // });
        // document.adoptedStyleSheets = [cssModule.default];


        // console.log(cssModule);

        import '/assets/ele/index.js?v=0.0.10';
        import { routerModule } from '/assets/wle-router.js?v=0.1.0'

        const { reactive, onMounted, computed, watchEffect, ref, watch } = globalThis.VueDemi;
        import { Nid, g, hc2, ForEach, Column, Text, BaseVmControl, injectControl, useControl, getAllComments, getcustomComponents } from "wle";

        window.getAllComments = getAllComments;

        import { runApp, routes } from "/assets/app.js"

        let rooterRootEle = document.getElementById("routerroot")



        let keepLives = [
            // '404'
        ]

        let app = useControl('app');

        let isLoaded = false;

        window.getApp = function () {
            return {
                $vm: app,
                isLoaded,
                globalConfig: globalThis.appConfig
            }
        }

        let option = {
            rooterRootEle,
            routes,
            pageBeforeRender,
            keepLives,
        }

        const NAV_SELECTED_CLS = 'nav--seleted';

        let cachedRootDom = null;

        let currentTabIndex = 0;

        /**
         * @param nav {Element} 
         */
        function resetNav(app, nav, {currentIndex = currentTabIndex} = {}) {
            nav.innerHTML = ''
            hc2(ForEach, {
                args: [{ list: app.navs }], init: (ele, option) => {
                    let name = option.item[0];
                    let label = option.item[1]?.label;
                    let ctx = hc2(Text, { args: [label], attrs: {} }, ele);
                    ctx.ele.classList.add('nav__link')
                    if (option.index === currentIndex) {
                        ctx.ele.classList.add(NAV_SELECTED_CLS)
                    }
                    ctx.ele.onclick = function () {
                        let currentName = location.hash.replace('#/', '')
                        // console.log(name,currentName );
                        if (currentName === name) {
                            return
                        }
                        currentTabIndex = option.index;
                        globalThis.wRoute.switchTab(name, {
                            paramA: 'from nav'
                        })
                    }
                }
            }, nav);
            // console.log('currentIndex', currentIndex);
            if (currentIndex > -1) {
                nav.style.display = null
            } else {
                nav.style.display = 'none'
            }
        }


        document.addEventListener('route-change', function(e) {
            let pages = window.getCurrentPages();

            if (pages && pages.length > 0) {
                currentTabIndex = app.getNavIndex(pages.at(-1)?.routerName);
                let nav  = document.querySelector('#nav');
                console.log('route-change', pages, currentTabIndex);
                resetNav(app, nav)
            }
        })
        

        /**
         *@param rooterRootEle {Element} 
         */
        function pageBeforeRender(rooterRootEle, firstBuild) {
            if (firstBuild) {
                rooterRootEle.classList.add('dis-flex');

                let nav = document.createElement('div')
                nav.id = 'nav'
                let dom = document.createElement('div')
                dom.classList.add('a-hide-in-mobile')
                dom.innerHTML = '切换主题'
                dom.onclick = function () {
                    document.documentElement.classList.toggle('theme-dark')
                }
                nav.appendChild(dom);

                let routeName = window.wRoute.routeName();
                currentTabIndex = app.getNavIndex(routeName);
                console.log(routeName);

                resetNav(app, nav)

                let mainContent = document.createElement('div');
                mainContent.id = 'mainContent';
                mainContent.classList.add('flex-1');
                mainContent.classList.add('overflow-hidden');
                mainContent.style['overflow-y'] = 'auto';


                let vueapphack = document.createElement('div');
                mainContent.appendChild(vueapphack);



                rooterRootEle.appendChild(nav)
                rooterRootEle.appendChild(mainContent);

                setTimeout(() => {
                    vueapp.mount(vueapphack)
                }, 30);

                cachedRootDom = mainContent;

                // console.log(mainContent);
                return {
                    tureRoot: mainContent
                }
            } else {
                // console.log('load from cache', cachedRootDom);
                let nav  = document.querySelector('#nav');
                resetNav(app, nav)
                return {
                    tureRoot: cachedRootDom
                }
            }
        }



        routerModule(option);

        const pinia = Pinia.createPinia()
        vueapp.use(pinia);

        let pages = getCurrentPages();
        // console.log(pages);

        runApp(Pinia, rooterRootEle);

        isLoaded = true;

        pages.forEach(page => {
            if (page?.lifeTimes?.onReady) {
                page.lifeTimes.onReady(globalThis)
            }
        })
    </script>
    <script>
        function __load_async_lib() {
            let asyncLib = [
                '/assets/virtualized-list.min.js',
                'https://cdn.jsdelivr.net/npm/swiper@10/swiper-element-bundle.min.js',
            ];
            asyncLib.forEach(libSrc => {
                let script = document.createElement('script');
                script.src = libSrc;
                document.body.appendChild(script)
            })
        }
        __load_async_lib()
    </script>
</body>

</html>