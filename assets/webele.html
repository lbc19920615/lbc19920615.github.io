<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="webele"></div>
    <script type="module">
import { reactive, onMounted, computed, effect, effectScope, watchEffect, ref, watch } from "https://cdn.bootcdn.net/ajax/libs/vue/3.2.47/vue.esm-browser.js"

function Nid() {
    return crypto.randomUUID()
}

function appendCommon(ctx, ele) {
    let curRoot = ctx.curRoot
    if (Array.isArray(ctx.curRoot)) {
        curRoot =  ctx.curRoot[1]
        // console.dir(curRoot);
    }
    if (curRoot.nodeType === 8) {
        curRoot.before(ele)
    }
    else {
        if (Array.isArray(ele)) {
            curRoot.append(...ele)
        } else {
            curRoot.append(ele)
        }
    }
}

function createCommonCtx(callback, {ele, id = Nid()} = {}) {
    let ctx =  {
        id,
        curRoot: undefined,

        done() {
            appendCommon(ctx, ele)
            callback(ele)
        }
    }
    return ctx
}

function createForeachCtx(callback, {ele, max =  0, list, id = Nid()} = {}) {
    let ctx =  {
        id,
        curRoot: undefined,
        done() {
            appendCommon(ctx, ele);
            ctx.build(max, list)
        },
        reload({max, list} ={}) {
           while (ele[0].nextSibling !== ele[1]) {
            ele[0].nextSibling.remove()
           }
        //    console.log(max);
           ctx.build(max, list)
        },
        build(innerMax, innerList) {
            if (innerList) {
                for (let index = 0; index < innerList.length; index++) {
                    callback(ele, {index, item: innerList[index]})                
                }
            }
            else {
                for (let index = 0; index < innerMax; index++) {
                    callback(ele, {index})                
                }
            }
        }
    }
    return ctx
}


function Button({action, text} = {}) {
    let ele = document.createElement('button')
    ele.classList.add('button')
    ele.onclick = function(e) {
        action(e)
    }
    ele.textContent = text
    return {
        init(callback) {
            // console.log(callback);
            return function () {
                let ctx =  createCommonCtx(callback, {ele})
                return ctx
            }
        }
    }
}

function Column() {
    let ele = document.createElement('div')
    ele.classList.add('column')
    return {
        init(callback) {
            // console.log(callback);
            return function () {
                let ctx =  createCommonCtx(callback, {ele})
                return ctx
            }
        }
    }
}

function Text(text = '') {
    let ele = document.createElement('div')
    ele.classList.add('text')
    ele.textContent = text
    return {
        init(callback) {
            // console.log(callback);
            return function () {
                let ctx =  createCommonCtx(callback, {ele})
                return ctx
            }
        }
    }
}

function ForEach({max = ref(0), list = ref([])} = {}) {
    let startFlg = document.createComment('start')
    let endFlg = document.createComment('end')
    let ele = [
        startFlg,
        endFlg
    ]

    // let computeMax = computed(() => max)
    
    let obj = reactive({
        max,
        list
    })

    // console.log(list);
    watch(list,  (newVal, oldVal) => {
        console.log('list', newVal, oldVal);
        ctx.reload({max: obj.max, list: obj.list})
    }, {
        deep: true
    })

    let ctx;
    return {
        init(callback) {
            // console.log(callback);
            return function () {
                ctx =  createForeachCtx(callback, {ele, max: obj.max, list: obj.list})
                return ctx
            }
        }
    }
}

function defc(buildCtx, runFun) {
    let ctx = buildCtx()
    runFun(ctx)
}

let g = {
    defc
}


let rootEle = document.createElement('div')

let ele = rootEle;
let vm = (function() {
    let data = reactive({
        some: "",
        max: 1,
        list: [1,2,3]
    })
    return {
        action(e) {
            data.some = Nid()
            console.log('action', data, e);
        },
        data
    }
})();

let vmData = vm.data;

let vmDataList = vmData.list

setTimeout(() => {
    vmData.list[0] = 3;
}, 3000)


g.defc(Column().init(function (ele) {
    ; g.defc(Text('space').init(function (ele) { }), function (ctx) {
        // ctx.fontSize(9).fontColor(0xCCCCCC).width('90%');
        ctx.curRoot = ele;
        ctx.done()
    });
    g.defc(Column({space: 5}).init(function (ele) {

        ; g.defc(Button({ text: 'button', action: vm.action }).init(function (ele) { }), function (ctx) {
            // ctx.width('100%').height(30).backgroundColor(0xAFEEEE);
            ctx.curRoot = ele;
            ctx.done()
        });


        ; g.defc(ForEach({list: vmDataList}).init(function (ele, option) {
            g.defc(Text(option.item).init(function (ele) {

            }), function (ctx) { ctx.curRoot = ele; ctx.done() })
         }), function (ctx) {
            // ctx.width('100%').height(30).backgroundColor(0x00FFFF);
     
            ctx.curRoot = ele;
            ctx.done()
        });

    }), function (ctx) {
        // ctx.width('90%').height(100).border({ width: 1 });
        ctx.curRoot = ele;
        ctx.done()
    });

}), function (ctx) { ctx.curRoot = ele; ctx.done() })

document.querySelector('#webele').appendChild(rootEle)
    </script>
</body>
</html>